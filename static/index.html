<!DOCTYPE html>
<html>
  <head>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background-color: black;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas></canvas>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();

      socket.on("btn", (num) => {
        if (!running) {
          return go();
        }
        // is there a note?
        const elapsed = (Date.now() - start) / SECRET_SPEED_DO_NOT_TOUCH;
        const maybeNoteIndex = NOTES.findIndex(
          ([note, time]) =>
            note === num - 1 && elapsed > time - 0.5 && elapsed < time + 0.5
        );
        if (maybeNoteIndex !== -1) {
          console.log("got note!");
          NOTES[maybeNoteIndex][2] = true;
        } else {
          console.log("FAIL");
        }
      });

      const audio = new Audio("song2.mp3");
      document.body.onclick = () => go();

      const _NOTES = [[1,6.6033333333333335],[2,9.76],[0,11.863333333333333],[3,12.916666666666666],[2,15.023333333333333],[1,18.18],[1,23.44333333333333],[2,26.60333333333333],[0,28.706666666666667],[3,29.76],[2,31.863333333333333],[3,33.443333333333335],[2,35.02333333333333],[0,36.60333333333333],[1,37.916666666666664],[0,40.28666666666667],[1,41.34],[2,42.39],[3,43.443333333333335],[0,44.49666666666667],[2,45.55],[1,46.60333333333333],[0,48.70666666666666],[1,49.76],[2,50.81333333333333],[3,51.86333333333334],[1,52.916666666666664],[0,53.97],[3,55.02333333333333],[1,56.07666666666667],[2,57.126666666666665],[0,58.18],[1,60.28666666666667],[2,61.86333333333334],[3,62.916666666666664],[1,65.55],[2,72.39],[3,72.91666666666667],[1,73.97],[2,73.97],[0,75.55],[1,76.07666666666667],[3,77.12666666666667],[2,77.65333333333334],[1,78.18],[0,78.70666666666666],[2,79.23333333333333],[3,79.76],[1,80.28666666666666],[0,82.39],[3,83.44333333333333],[2,85.55],[3,87.12666666666667],[2,88.70666666666666],[2,90.81333333333333],[3,90.81333333333333],[0,92.39],[1,92.91666666666667],[3,93.97],[2,94.49666666666667],[1,95.02333333333333],[0,95.55],[2,96.07666666666667],[3,96.60333333333334],[1,97.12666666666667],[0,99.23333333333333],[1,99.76],[2,100.28666666666666],[0,101.34],[3,102.39],[2,102.91666666666667],[1,103.44333333333333],[3,104.49666666666667],[0,105.55],[0,107.65333333333334],[1,107.65333333333334],[2,109.23333333333333],[1,109.76],[3,110.81333333333333],[2,111.34],[0,111.86333333333333],[1,112.39],[2,112.91666666666667],[3,113.44333333333333],[0,113.97],[0,119.23333333333333],[1,120.81333333333333],[0,122.39],[3,125.55],[0,127.65333333333334],[0,129.76],[1,130.81333333333333],[3,131.51333333333332],[0,132.21666666666667],[2,132.91666666666666],[3,141.34],[0,141.34],[1,142.91666666666666],[2,143.44333333333333],[3,144.49666666666667],[0,145.02333333333334],[1,147.65333333333334],[0,149.76],[1,149.76],[1,151.86333333333334],[3,152.91666666666666],[2,158.18],[3,158.18],[0,159.76],[3,160.28666666666666],[1,161.34],[2,161.86333333333334],[3,164.49666666666667],[2,166.60333333333332],[3,166.60333333333332],[2,168.70666666666668],[0,169.76],[3,170.28666666666666],[1,171.34],[3,171.86333333333334],[0,172.91666666666666],[2,173.44333333333333],[3,175.02333333333334],[0,175.02333333333334],[1,176.60333333333332],[2,177.12666666666667],[0,178.18],[1,178.70666666666668],[3,179.23333333333332],[2,179.76],[1,180.28666666666666],[0,180.81333333333333],[3,181.34],[0,183.44333333333333],[1,183.44333333333333],[1,185.55],[3,186.60333333333332],[0,187.12666666666667],[1,188.18],[2,188.70666666666668],[0,189.49666666666667],[3,190.28666666666666],[0,190.81333333333333],[3,191.86333333333334],[2,191.86333333333334],[1,193.44333333333333],[2,193.97],[0,195.02333333333334],[3,195.55],[1,196.07666666666665],[2,196.60333333333332],[1,197.12666666666667],[0,197.65333333333334],[3,198.18],[0,200.28666666666666],[1,200.28666666666666],[3,201.34],[0,201.86333333333334],[2,202.91666666666666],[2,204.49666666666667],[3,204.49666666666667],[0,205.55],[3,206.07666666666665],[1,207.12666666666667],[0,208.70666666666668],[3,210.81333333333333],[0,211.86333333333334],[0,213.44333333333333],[0,213.97],[3,215.02333333333334],[0,215.55],[2,216.34],[1,217.12666666666667],[3,219.23333333333332],[0,220.28666666666666],[0,221.86333333333334],[0,222.39],[2,223.97],[1,224.49666666666667],[0,225.02333333333334],[3,225.55],[0,227.65333333333334],[3,228.70666666666668],[3,230.28666666666666],[3,230.81333333333333],[0,231.86333333333334],[3,232.39],[1,233.18],[2,233.97],[0,236.07666666666665],[3,237.12666666666667],[0,237.65333333333334],[0,242.39],[3,242.39],[2,245.55],[0,247.65333333333334],[3,248.70666666666668],[2,250.81333333333333],[1,253.97],[1,259.23333333333335],[3,260.2866666666667],[0,261.34],[2,262.39],[0,263.4433333333333],[1,264.49666666666667],[3,265.55],[2,266.60333333333335],[0,267.6533333333333],[1,268.70666666666665],[2,269.76],[3,270.81333333333333],[1,271.86333333333334],[2,272.6533333333333],[0,273.4433333333333],[3,274.23333333333335],[1,275.0233333333333],[2,275.55],[0,276.07666666666665],[3,284.49666666666667],[0,291.34],[3,291.86333333333334],[0,292.9166666666667],[1,292.9166666666667],[3,293.97],[1,294.49666666666667],[2,295.0233333333333],[2,296.07666666666665],[0,296.60333333333335],[1,297.12666666666667],[1,298.18],[2,298.70666666666665],[3,299.23333333333335],[1,300.2866666666667],[0,301.34],[0,302.39],[1,302.9166666666667],[2,303.4433333333333],[3,304.49666666666667],[1,305.55],[1,306.60333333333335],[2,307.12666666666667],[0,309.76],[1,309.76],[3,310.81333333333333],[1,311.34],[2,311.86333333333334],[2,312.9166666666667],[0,313.4433333333333],[1,313.97],[1,315.0233333333333],[2,315.55],[3,316.07666666666665],[0,317.12666666666667],[2,318.18],[0,319.23333333333335],[1,319.76],[2,320.2866666666667],[1,321.34],[2,321.86333333333334],[3,322.39],[0,323.18],[3,323.97],[1,326.60333333333335],[0,326.60333333333335],[3,327.6533333333333],[1,328.18],[2,328.70666666666665],[2,329.76],[0,330.2866666666667],[1,330.81333333333333],[1,331.86333333333334],[2,332.39],[3,332.9166666666667],[0,333.97],[0,336.07666666666665],[1,336.60333333333335],[2,337.12666666666667],[3,338.18],[1,339.23333333333335],[1,340.2866666666667],[2,340.81333333333333],[3,343.4433333333333],[3,344.23333333333335],[1,345.0233333333333],[2,345.55],[2,346.34],[0,347.12666666666667],[1,347.6533333333333],[1,348.4433333333333],[2,349.23333333333335],[0,351.86333333333334],[1,352.9166666666667],[2,353.97],[3,355.0233333333333],[0,356.07666666666665],[3,356.86333333333334],[0,357.6533333333333],[3,358.4433333333333],[2,360.2866666666667],[3,360.2866666666667],[2,363.4433333333333],[0,365.55],[3,366.60333333333335],[1,367.6533333333333],[2,368.70666666666665],[0,371.86333333333334],[3,374.49666666666667],[2,375.0233333333333],[1,375.55]]
      const NOTES = _NOTES.map(([a,b])=>[a,b + 0.33])

      // seconds it takes for a block to scroll down the the entire screen
      const SPEED = 4;
      const TICKS_PER_SECOND = 100;
      const LINE_HEIGHT = 160.5;
      const START_DELAY = 2;

      const SECRET_SPEED_DO_NOT_TOUCH = 300;

      let start = Date.now();

      let running = false;

      const canvas = document.querySelector("canvas");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const ctx = canvas.getContext("2d");

      ctx.textAlign = "center";
      ctx.font = "50px sans-serif";
      ctx.fillStyle = "white";
      ctx.fillText(
        "press any button to play",
        canvas.width / 2,
        canvas.height / 2
      );

      setInterval(() => {
        if (!running) return;

        const elapsed = Date.now() - start;
        const seconds = elapsed / SECRET_SPEED_DO_NOT_TOUCH;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // if no notes left, end game
        if (NOTES.every(([, time]) => time < seconds - 1)) {
          ctx.fillStyle = "white";
          const missedNotes = NOTES.filter(
            ([, , pressed]) => pressed == -1
          ).length;
          ctx.fillText(
            `you missed ${missedNotes} notes. press any button to play again`,
            canvas.width / 2,
            canvas.height / 2
          );
          running = false;
          return;
        }

        ctx.fillStyle = "white";
        // ctx.fillText(seconds, 0, canvas.height - 10);

        NOTES./* filter(([, time]) => time >= seconds - SPEED). */ forEach(
          ([note, time, pressed], index) => {
            const x = note * 200 + 300;
            const y =
              ((seconds - time) / SPEED + 1) * canvas.height -
              (LINE_HEIGHT + 50);
            if (pressed == 1) {
              ctx.fillStyle = "#00ff00";
            } else if (
              pressed == -1 ||
              (!pressed && y > canvas.height - (LINE_HEIGHT + 80))
            ) {
              ctx.fillStyle = "red";
              NOTES[index][2] = -1;
            } else {
              ctx.fillStyle = "white";
            }
            ctx.fillRect(x, y, 70, 50);
          }
        );

        ctx.strokeStyle = ["#ff0000", "#aa0000"][
          Math.floor(elapsed / SECRET_SPEED_DO_NOT_TOUCH) % 2
        ];
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(0, canvas.height - LINE_HEIGHT);
        ctx.lineTo(canvas.width, canvas.height - LINE_HEIGHT);
        ctx.stroke();
      }, 10);

      function go() {
        start = Date.now() + START_DELAY * 1000;
        running = true;
        setTimeout(() => audio.play(), START_DELAY * 1000 - 100);
        NOTES.forEach((note) => (note[2] = false));
      }
    </script>
  </body>
</html>